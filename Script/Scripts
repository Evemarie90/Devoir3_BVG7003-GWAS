library(data.table)
library(rMVP)
library(bigmemory)

setwd("C:/Users/joell/Desktop/Devoir3_bioinfo")
hmp_data <- fread("African_SNPs.hmp.txt", header = TRUE)

# Pour sélectionner aléatoirement 100 échantillons pour tester le code
set.seed(42)  # Vous pouvez choisir n'importe quel nombre
remaining_columns <- colnames(hmp_data)[12:ncol(hmp_data)]
random_columns <- sample(remaining_columns, 100)
selected_columns <- c(colnames(hmp_data)[1:11], random_columns)
test <- hmp_data[, ..selected_columns]
write.table(test, file = "test_file.hmp.txt", sep = "\t", row.names = FALSE, quote = FALSE)


# 4.1 Preparation des fichiers de genotype et phenotype
# - Fichier de genotype (Hapmap) et phenotype (Phenotype_African.txt) sont fournis
# - rMVP les charge et genere les fichiers de genotype, phenotype et carte genetique
MVP.Data(fileHMP = "test_file.hmp.txt",  # Fichier Hapmap du genotype
         filePhe = "Phenotype_African.txt",  # Fichier de phénotype
         sep.phe = "\t",  # Separateur de colonnes dans le fichier de phenotype
         out = "mvp.hmp")  # Nom de la sortie (base de noms pour les fichiers generees)

# 4.2 Chargement des fichiers generes par MVP.Data
# - Charge les fichiers de genotype, phenotype et carte genetique
# - Les fichiers .desc, .phe et .map sont créés automatiquement

genotype <- attach.big.matrix("mvp.hmp.geno.desc")  # Charge la matrice de genotype
phenotype <- read.table("mvp.hmp.phe", header = TRUE)  # Charge le fichier de phénotype
map <- read.table("mvp.hmp.geno.map", header = TRUE) # Charge la carte genetique

# Pour déterminer le nombre d'axes significatives à mettre dans l'analyse MVP
genotype_matrix <- as.matrix(genotype)
pca_results <- prcomp(genotype_matrix, scale. = TRUE)  # Effectue une ACP sur le genotype
explained_variance <- pca_results$sdev^2 / sum(pca_results$sdev^2)
plot(explained_variance, type = "b", pch = 19,  
     xlab = "Composante principale", 
     ylab = "Proportion de la variance expliquée",
     main = "Scree Plot", xlim = c(1, 30))


# 9. Exporter le fichier filtré
write.table(filtered_hmp, file = "filtered_hmp.hmp.txt", sep = "\t", row.names = FALSE, quote = FALSE)


# 6.3 Incorporation des covariables dans l'analyse GWAS
for(i in 2:ncol(phenotype)){
  imMVP <- MVP(
    phe = phenotype[, c(1, i)],  # Extraire la colonne du phenotype correspondant
    geno = genotype,  # Matrice de genotype
    map = map,  # Carte genetique
    nPC.MLM = 4,  # Inclure 4 composantes principales dans MLM
    maxLine = 10000,  # Nombre maximal de lignes traitees 
    vc.method = "BRENT",  # Methode d'estimation des composantes de variance
    method.bin = "static",  # Methode de binning pour FarmCPU
    threshold = 0.05,  # Seuil de significativite pour le GWAS
    method = "MLM",  # Methodes d'analyse GWAS
    file.output = c("pmap", "pmap.signal", "plot", "log")  # Fichiers de sortie
  )
  gc()  # Nettoie la memoire a chaque iteration pour eviter l'accumulation de memoire
}
